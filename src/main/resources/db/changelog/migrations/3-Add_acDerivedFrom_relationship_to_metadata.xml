<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd" objectQuotingStrategy="QUOTE_ONLY_RESERVED_WORDS">

  <changeSet id="3-Add_acDerivedFrom_relationship_to_metadata" context="schema-change" author="keyuk">

    <!-- Add the column -->
    <addColumn tableName="metadata">
      <column name="ac_derived_from_id" type="INTEGER" />
    </addColumn>

    <!-- Foreign key constraint -->
    <addForeignKeyConstraint
      baseColumnNames="ac_derived_from_id"
      baseTableName="metadata"
      constraintName="fk_metadata_ac_derived_from_id"
      referencedColumnNames="id"
      referencedTableName="metadata"/>

    <!-- add check to prevent derived from self -->
    <sql>
      ALTER TABLE metadata ADD CONSTRAINT check_not_derived_from_self CHECK (ac_derived_from_id != id)
    </sql>

  </changeSet>

</databaseChangeLog>

